{% extends 'developer_auth/dash_base.html' %}

{% block content %}
<main class="flex-1 overflow-y-auto p-6 bg-slate-50">
                
                <div class="flex justify-between items-center mb-6">
                    <p class="text-sm text-slate-500">Manage your API keys for accessing the E-Commerce API.</p>
                    <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Create New Key
                    </button>
                </div>

                <!-- Active Keys -->
                <div class="space-y-4">
                    <!-- Key 1 -->
                    
                    <!-- Key 2 -->
                    {% if keys %}
                    {% for key in keys %}
                        {% if key.is_active %}
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-1">
                                        <h3 class="font-semibold text-slate-800">{{ key.name }}</h3>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Active</span>
                                    </div>
                                    <p class="text-xs text-slate-500">Created on {{ key.created_at | date:"F j, Y" }}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="text-slate-400 hover:text-slate-600 p-2"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="openDeleteModal('{{ forloop.counter }}')" class="text-slate-400 hover:text-red-600 p-2"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Public Key</label>
                                    <div class="flex">
                                        <input type="text" value="{{ key.public_key }}" readonly class="flex-1 bg-slate-50 border border-slate-200 rounded-l-lg px-3 py-2 text-sm font-mono text-slate-600 focus:outline-none">
                                        <button onclick="copyToClipboard('{{ key.public_key }}', this)" class="bg-slate-100 border border-l-0 border-slate-200 rounded-r-lg px-3 hover:bg-slate-200 text-slate-500">
                                            <i class="fa-regular fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Secret Key</label>
                                    <div class="flex">
                                        <input id="secretKey-{{ forloop.counter }}" type="password" value="{{ key.secret_key}}" readonly class="flex-1 bg-slate-50 border border-slate-200 rounded-l-lg px-3 py-2 text-sm font-mono text-slate-600 focus:outline-none">
                                        <button onclick="toggleSecret('secretKey-{{ forloop.counter }}', 'eyeIcon-{{ forloop.counter }}')" class="bg-slate-100 border border-l-0 border-slate-200 px-3 hover:bg-slate-200 text-slate-500">
                                            <i id="eyeIcon-{{ forloop.counter }}" class="fa-regular fa-eye"></i>
                                        </button>
                                        <button onclick="copyToClipboard('{{ key.secret_key }}', this)" class="bg-slate-100 border border-l-0 border-slate-200 rounded-r-lg px-3 hover:bg-slate-200 text-slate-500">
                                            <i class="fa-regular fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delete Key Modal -->
                        <div id="deleteKeyModal-{{ forloop.counter }}" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0" style="transition: opacity 0.2s ease-in-out;">
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-200" id="deleteModalContent">
                                
                                <div class="p-6 text-center">
                                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fa-solid fa-trash-can text-red-600 text-xl"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Revoke API Key?</h3>
                                    <p class="text-sm text-slate-500 mb-6">
                                        Are you sure you want to delete this API key? Any applications using this key will immediately lose access to the API. This action cannot be undone.
                                    </p>
                                    
                                    <div class="flex justify-center gap-3">
                                        <button onclick="closeDeleteModal('{{ forloop.counter }}')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors">
                                            Cancel
                                        </button>
                                        <button hx-post="{% url 'revoke-key' key.public_key %}" hx-target="body" hx-swap="outerHTML" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-sm transition-colors">
                                            Yes, Revoke Key
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 opacity-75">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-1">
                                        <h3 class="font-semibold text-slate-800">{{ key.name }}</h3>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600">Revoked</span>
                                    </div>
                                    <p class="text-xs text-slate-500">Created on {{ key.created_at | date:'F j, Y' }} â€¢ Revoked on {{ key.revoked_at | date:'F j, Y' }}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="text-slate-400 hover:text-red-600 p-2"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Public Key</label>
                                    <div class="flex">
                                        <input type="text" value="pk_test_82Jk...55m" readonly class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-400 focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Secret Key</label>
                                    <div class="flex">
                                        <input type="text" value="sk_test_****************" readonly class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-400 focus:outline-none">
                                    </div>
                                </div>
                            </div>
                        </div> 
                        {% endif %}
                    {% endfor %}    
                    {% endif %}
                    
                
                        <!-- API Key Generation Modal -->
                        <div id="apiKeyModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0" style="transition: opacity 0.2s ease-in-out;">
                            <!-- Modal Content -->
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-200" id="modalContent">
                                
                                <!-- Header -->
                                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                                    <h3 class="text-lg font-semibold text-slate-800">Generate New API Key</h3>
                                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                                        <i class="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>
                                
                                <!-- Body -->
                                <div class="p-6 space-y-4">
                                    <!-- Warning Alert -->
                                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 flex gap-3">
                                        <i class="fa-solid fa-triangle-exclamation text-amber-500 mt-0.5"></i>
                                        <div class="text-sm text-amber-800">
                                            <p class="font-medium">Warning: Action Irreversible</p>
                                            <p class="mt-1 text-amber-700/80">Generating a new key will immediately invalidate the existing Secret Key. You must update your applications immediately.</p>
                                        </div>
                                    </div>
                                    <form id="generate_key_form-{{ forloop.counter }}" method="POST" action="{% url 'generate-api-key' %}">
                                    {% csrf_token %}
                                    <!-- Input Field -->
                                    <input type="hidden" name="mode" value="test">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Key Label (Optional)</label>
                                        <input name="api_key_name" type="text" placeholder="e.g. Production Server 1" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm transition-shadow">
                                    </div>
                                    
                                    <!-- Password Confirmation (Optional Security) -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Confirm Password</label>
                                        <input name="password" type="password" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm transition-shadow">
                                    </div>
                                    </form>
                                </div>

                                <!-- Footer -->
                                <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end gap-3 border-t border-slate-100">
                                    <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-200 rounded-lg transition-colors">
                                        Cancel
                                    </button>
                                    <button type="submit" form="generate_key_form-{{ forloop.counter }}" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm transition-colors flex items-center gap-2">
                                        <i class="fa-solid fa-rotate"></i> Generate Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                </div>

            </main>   
            <!-- ...existing code... -->

{% endblock content %}

{% block extra_js %}
    <script>
    // Modal Logic
    function openModal() {
        const modal = document.getElementById('apiKeyModal');
        const content = document.getElementById('modalContent');
        
        modal.classList.remove('hidden');
        // Small delay to allow display:flex to apply before opacity transition
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.classList.add('flex');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }, 10);
    }

    function closeModal() {
        const modal = document.getElementById('apiKeyModal');
        const content = document.getElementById('modalContent');
        
        modal.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 200); // Match transition duration
    }

    // Close on backdrop click
    document.getElementById('apiKeyModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script> 

<script>
    // --- API Key Management Logic ---

    /**
     * Toggles the visibility of the Secret Key input field.
     * @param {string} inputId - The ID of the input element.
     * @param {string} iconId - The ID of the icon element (optional).
     */
    function toggleSecret(inputId, iconId = 'eyeIcon') {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        
        if (input.type === 'password') {
            input.type = 'text';
            if(icon) {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        } else {
            input.type = 'password';
            if(icon) {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    }

    /**
     * Copies text to clipboard and shows a temporary tooltip/alert.
     * @param {string} text - The text to copy.
     * @param {HTMLElement} btnElement - The button that was clicked (for visual feedback).
     */
    function copyToClipboard(text, btnElement) {
        navigator.clipboard.writeText(text).then(() => {
            // Visual feedback
            if (btnElement) {
                const originalIcon = btnElement.innerHTML;
                btnElement.innerHTML = '<i class="fa-solid fa-check text-green-600"></i>';
                setTimeout(() => {
                    btnElement.innerHTML = originalIcon;
                }, 2000);
            } else {
                alert('Copied to clipboard!');
            }
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    // --- Modal Logic (Generic) ---

    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        const content = modal.querySelector('div[id$="Content"]'); // Finds the inner content div
        
        if (show) {
            modal.classList.remove('hidden');
            // Small delay for transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.classList.add('flex');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        } else {
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        }
    }

    // Specific Modal Wrappers
    function openModal() { toggleModal('apiKeyModal', true); }
    function closeModal() { toggleModal('apiKeyModal', false); }
    
    function openDeleteModal(id) { toggleModal('deleteKeyModal-' + id, true); }
    function closeDeleteModal(id) { toggleModal('deleteKeyModal-' + id, false); }

    // Close modals on backdrop click
    window.onclick = function(event) {
        if (event.target.id === 'apiKeyModal') closeModal();
        if (event.target.id && event.target.id.startsWith('deleteKeyModal-')) {
            const id = event.target.id.replace('deleteKeyModal-', '');
            closeDeleteModal(id);
        }
    }
</script>

<script>
    document.addEventListener("htmx:configRequest", (event) => {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        event.detail.headers['X-CSRFToken'] = csrfToken;
    });
</script>

{% endblock extra_js %}